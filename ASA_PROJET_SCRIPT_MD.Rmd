---
title: "ASA PROJET"
author: "Raphaëlle Lebailly, Pierre-Alexandre Quittet, Bastien Clemot, Chloé Pérou"
date: "2023-10-05"
output: html_document
---

```{r, warning=F, message=F, echo = F}
rm(list=ls())  # Efface les variables créées lors des exécutions précédentes
graphics.off() # Ferme les fenêtres ouvertes lors des exécutions précédentes
```


Lien GitHub du projet : https://github.com/bClemot-Sc/Projet-ASA

# Packages ----------------------------------------------
#### Installation (si nécessaire)
```{r}
# install.packages("corrplot")  
# install.packages("ade4")
# install.packages("lubridate") 
# install.packages("car")  
# install.packages("lme4")
# install.packages("caret") 
# install.packages("missMDA")
# install.packages("plyr")

```

#### Chargement ----------------------------------------------

```{r,  warning=F, message=F}
library(corrplot)  # Matrice de corrélation
library(ade4)
library(lubridate)  # Convertir données temporelles en secondes
library(car)  # Fonction vif() et anova()
library(lme4)  # Modèle gaussien mixte
library(caret) # Validation croisée
library(missMDA)
library(plyr)
```

# Sujet d'étude : Data butterfly ----------------------------------------------

Etude des effets du génotype, du métabolisme et des conditions environnementales sur les conditions thermiques des papillons en vol. 


# Importer les data ----------------------------------------------

Le fichier de données possède 32 variables métaboliques, génotypiques et environementales. Les variables sont les suivantes :

  - **ID** : identié du papillon
  - **eclosion_day** : jour d'éclosion
  - **sex** : sexe
  - **FMR_day** : jour de la mesure du taux métabolique pendant le vol
  - **age_FMR** : age au temps de la mesure de FMR
  - **mass** : masse de l'individu
  - **FMR** : taux métabolique en vol estimé avec le CO² total émis pendant 7 minutes de vol dans des conditions de contrôle corrigé par le taux métabolique au repos
  - **flight_day** : jour de vol
  - **age_flight** : âge au jour de vol
  - **sun_flight** : index de soleil [0 = pas de nuage , ... ,5 totalement nuageux]
  - **wind_flight** : index de vent [0 = pas de vent, ..., 5 = très venteux]
  - **air_T** : température de l'air pendant le vol
  - **dew_flight** : point de rosée
  - **humidity_flight** : humidité relative (%)
  - **solar_radiation_flight** : radiation solaire pendant le vol
  - **flight_duration** : temps de vol
  - **disturbed_flight** : nécessité d'aider le papillon à voler ? [YES ; NO]
  - **stop_flight** : nécessité d'arrêter le vol du papillon à la fin de l'expérience ? [YES ; NO]
  - **takeoff_time** : horaire au décollage
  - **takeoff_T_thorax** : température moyenne à la surface du thorax au décollage
  - **end_flight_time** : horaire de fin de vol
  - **mean_T_flight** : température moyenne à la surface du thorax pendant le vol
  - **fln_113** :	SNP position 113 du gène fln flightin (lié à la capacité de vol)
  - **G6p1d_239**	: SNP position 239 du gène G6p1d glucose 6 phosphate 1 déshydrogénase
  - **Hsp70_1_206**	: Position SNP 206 du gène hsp70_1 heat shock protein 1 (protéine   - exprimée en cas de stress thermique)
  - **Hsp70_1_134**	: SNP position 134 du gène hsp70_1 heat shock protein 1 (protéine   - exprimée en cas de stress thermique)
  - **Hsp70_3_71**	: SNP position 71 du gène hsp70_1 heat shock protein 1 (protéine   - exprimée en cas de stress thermique)
  - **Hsp70_4_166**	: SNP position 166 du gène hsp70_1 heat shock protein 1 (protéine   - exprimée en cas de stress thermique)
  - **Pgi_105**	: SNP position 105 du gène pgi phosphoglucose isomérase lié à plusieurs   - composantes de la condition physique en interaction avec la température (voir   - ci-dessous)
  - **Pgi_1083** : 	SNP position 1083 du gène pgi phosphoglucose isomérase lié à   - plusieurs composantes du fitness en interaction avec la température (voir   - ci-dessous)
  - **Pgi_331** :	La position SNP 331 du gène pgi phosphoglucose isomérase est liée à   - plusieurs composantes de l'aptitude à interagir avec la température (voir   - ci-dessous).
  - **SDHD_149** : Position SNP 149 du gène SDHD complexe succinate déshydrogénase
  - **TnT2_100** _	Position SNP 100 du gène TnT2 troponine T


\


  
```{r}
data <- read.table(
  file = "ASA_data_projet.txt",
  stringsAsFactors = T,
  header = T,
  na.strings = "NA",
  dec = ",",
  sep = ""
)
```

# Data cleaning ----------------------------------------------

#### --- Renomme les variables

On renomme les variables avec les noms ci-dessus (plus courts et explicites).

```{r}
colnames(data)[1:22] <- c(
  "ID",
  "eclosion_day",
  "sex",
  "FMR_day",
  "age_FMR",
  "mass",
  "FMR",
  "flight_day",
  "age_flight",
  "sun_flight",
  "wind_flight",
  "air_T",
  "dew_flight",
  "humidity_flight",
  "solar_radiation_flight",
  "flight_duration",
  "disturbed_flight",
  "stop_flight",
  "takeoff_time",
  "takeoff_T_thorax",
  "end_flight_time",
  "mean_T_flight"
)
```

\

#### --- Supprime la colonne "ID"

```{r}
data <- data[, !colnames(data) %in% "ID"]
```

\

#### --- Conversion des variables "heures" en seconde

```{r}
data$takeoff_time <-  format(as.POSIXct(data$takeoff_time, format = "%H:%M:%S"), format = "%H:%M:%S")
data$end_flight_time <-  format(as.POSIXct(data$end_flight_time, format = "%H:%M:%S"), format = "%H:%M:%S")
```


\

#### --- Extraire les heures, les minutes et les secondes

```{r, message =F, warning= F}
for (variable_name in c("takeoff_time", "end_flight_time")){
  
  data[, variable_name] <- hms(data[, variable_name])
  heures <- hour(data[, variable_name])
  minutes <- minute(data[, variable_name])
  secondes <- second(data[, variable_name])
  
  # Convertir les heures, les minutes et les secondes en secondes
  data[, variable_name] <- heures * 3600 + minutes * 60 + secondes
}
```


\

#### --- Conversion des variables "facteurs"

```{r}
data$wind_flight <- as.factor(data$wind_flight)
data$sun_flight <- as.factor(data$sun_flight)
data$age_FMR <- as.factor(data$age_FMR)
# data$flight_day <- as.factor(data$flight_day)

# On recode les modalités de sexe
data$sex <- ifelse(
    test = data$sex == "FEMALE",
    yes = "F",
    no = "M"
  )

data$sex <- as.factor(data$sex)
```


\

#### --- Identification et visualisation des données manquantes

```{r}
# Identification des NAs par variables (en %)
data_na <-
  apply(
    X = data,
    MARGIN = 2,
    FUN = function(x) round(sum(is.na(x)) / nrow(data) * 100, 2)
  )
```

```{r, echo = F}
# On trie les variables par ordre croissant selon leur pourcentage en NA
data_na <- sort(data_na)

# Sélection d'un seuil critique > 30%
pos_na_30 <- which(data_na > 30)

# On différentie les variables avec des couleurs selon le seuil critique
couleurs <- rep("blue", length(data_na))
couleurs[pos_na_30] <- "red"

# Barplot
barplot(data_na, ylab="Proportion de NA (%)", main = "Proportion de NA",
        col = couleurs, las = 2, names=colnames(data_na), cex.names = .8)
abline(h = 30, col = "red", lwd =1.5)
```

\

#### --- Suppression des données manquantes
On supprime les variables ayant plus de 30% de données manquantes.
```{r}
#On garde une sauvegarde du dataset avec toutes les variables
data_full <- data

#On supprime les variables avec plus de 30% de données manquantes (NA)
data <- data[, !colnames(data) %in% names(data_na[data_na>30])]

#On supprime les individus avec des NAs pour la variable réponse (mean_T_flight) 
data <- data[!is.na(data$mean_T_flight),]
```

\
\

\
\

# VISUALISATION DES DONNEES

Dans cette analyse la variable réponse **y** est **mean_T_flight** représentant la température moyenne du thorax pendant le vol.

#### --- Visualisation de la variable mean_T_flight

```{r, echo = F}
par(mfrow = c(1, 3))
hist(data$mean_T_flight, pch = 16, col = 'blue', xlab = "y", main = "")
dotchart(data$mean_T_flight, pch = 16, col = 'blue', xlab = "y")
qqnorm(data$mean_T_flight, pch = 16, col = 'blue')
qqline(data$mean_T_flight, col = 'red')
```

La variable réponse suit une loi normale. Pas d'outliers détectés.

\

#### --- Visualisation des distribution des X

**Facteurs**

```{r, echo = F}
data_factor <- data[,sapply(data, is.factor)]  # factor columns identification

par(mfrow = c(2, 3))
i <- 1
visu <- apply(X = data_factor, MARGIN = 2,
      function(x) {
        bar <- barplot(table(x),main = colnames(data_factor)[i], cex.main = 1, ylab = "Effectifs",
                       ylim = c(0,max(table(x)) + 20))
        text(
          x = bar,
          y = table(x) - 1,
          label = table(x),
          pos = 3
        )  
        
        i <<- i + 1
      }
)
```

Les variables **sun_flight** et **wind_flight** ont une modalité ("1") avec respectivement, 1 et 2 réplicats. Ces modalités sont inutilisables pour estimer des paramètres. On créé donc une autre modalité : "\<2".

```{r}
# Reformatage
# --- Sun_flight
data$sun_flight <- ifelse(
    test = data$sun_flight == 1 | data$sun_flight == 2,
    yes = "<2",
    no = data$sun_flight
  )

# --- Wind_flight
data$wind_flight <- ifelse(
    test = data$wind_flight == 1 | data$wind_flight == 2,
    yes = "<2",
    no = data$wind_flight
  )


# Conversion en facteur
data$sun_flight  <- as.factor(data$sun_flight)
data$wind_flight <- as.factor(data$wind_flight)

# On modifie aussi data_factor
data_factor$sun_flight <- data$sun_flight
data_factor$wind_flight <- data$wind_flight

```

\

Revisualisation

```{r, echo = F}
par(mfrow = c(1, 2))

# sun_flight
bar <- barplot(table(data$sun_flight), main = "sun_flight", cex.main = .8, ylim = c(0, 60))
text(x = bar, y = table(data$sun_flight) - 1, label = table(data$sun_flight), pos = 3)  # Effectifs par catégorie

# wind_flight
bar <- barplot(table(data$wind_flight), main = "wind_flight", cex.main = .8, ylim = c(0, 60))
text(x = bar, y = table(data$wind_flight) - 1, label = table(data$wind_flight), pos = 3)  # Effectifs par catégorie

```


\

**Covariables**  
On visualise la distribution des variables quantitatives.

```{r, echo = F}
data_num <- data[,sapply(data, is.numeric)]  # factor columns identification

par(mfrow = c(2,4))
i <- 1
visu <- apply(X = data_num, MARGIN = 2, function(x){
  
  hist(x, main = colnames(data_num)[i])
  qqnorm(x, pch = 16)
  qqline(x, col = 'red')
  
  i <<- i + 1    
}
)

```

On tente de normaliser les données suivantes qui s'éloignent d'une loi Gaussienne :

-   Eclosion day
-   FMR_day
-   mass
-   humidity_flight
-   flight_duration
-   takeoff_time

On visualise respectivement les variables (1) sans transformation (2) log transformées et (3) racine carrée transformée :

```{r, echo = F}
vp_transfo <-
  c("eclosion_day",
    "mass",
    "FMR_day",
    "humidity_flight",
    "flight_duration",
    "takeoff_time"
  )

par(mfrow = c(2, 3))
for (i in vp_transfo){

    qqnorm(data[,i], pch = 16, main = "Sans transformation", ylab = i)
    qqline(data[,i], col = 'red')

    qqnorm(log(data[,i]), pch = 16, main = "Log transformation", ylab = i)
    qqline(log(data[,i]), col = 'red')

    qqnorm(sqrt(data[,i]), pch = 16, main = "Sqrt transformation", ylab = i)
    qqline(sqrt(data[,i]), col = 'red')
}

# for (i in vp_transfo){
# 
#     hist(data[,i], main = "Sans transformation", ylab = i)
# 
#     hist(log(data[,i]), main = "Log transformation", ylab = i)
# 
#     hist(sqrt(data[,i]), main = "Sqrt transformation", ylab = i)
# }

#data$eclosion_day <- log(data$eclosion_day)
#data$mass <- log(data$mass)
#data$FMR_day <- log(data$FMR_day)
#data$flight_day <- log(data$flight_day)
data$humidity_flight <- log(data$humidity_flight)
data$flight_duration <- log(data$flight_duration)
#data$takeoff_time <- log(data$takeoff_time)
```
On transorme les variables suivantes avec le logaritme pour 'normaliser' la distribution :

-   humidity_flight
-   flight_duration

\
\

#### --- Visualisation des distribution mean_T_flight \~ X
**Facteurs**
On visualise la distribution de la variable réponse **mean_T_flight** en fonction des variables catégorielles.

```{r, echo = F}
par(mfrow = c(2,4))
i <- 1
visu <- apply(X = data_factor, MARGIN = 2, function(x){
  
  boxplot(
    data$mean_T_flight ~ x,
    ylab = "y",
    xlab = "",
    main = colnames(data_factor)[i], 
    ylim = c(
      min(data$mean_T_flight, na.rm = T) - 1,
      max(data$mean_T_flight  + 1, na.rm = T)
    )
  )
  i <<- i + 1    
}
)
```

En considérant les barres d'erreurs, on n'observe pas de tendances notables entre les variables prédictives catégorielles et la variable réponse.

\

**Covariables**

```{r, echo = F}
par(mfrow = c(2,3))
i <- 1
visu <- apply(X = data_num[! colnames(data_num) %in% "mean_T_flight"], MARGIN = 2, function(x){
  
  plot(
    data$mean_T_flight  ~ x,
    ylab = "T",
    xlab = "",
    main = colnames(data_num)[i],
    ylim = c(
      min(data$mean_T_flight, na.rm = T) - 1,
      max(data$mean_T_flight  + 1, na.rm = T)
    )
  )
  abline(lm(data$mean_T_flight  ~ x), col = "red")
  
  i <<- i + 1    
}
)
```

On observe une relation linéaire positive entre **mean_T_flight** et les variables : eclosion_day, FMR_day, mass, air_T, flight_duration et takeoff_T_thorax. A l'inverse, on observe une relation linéaire négative entre **y** et age_flight, dew_flight, humidity_flight. Aucune relation entre **y** et les variables FMR, solar_radiation_flight, takeoff_time et end_flight_time.

\


# Intéractions entre y \~ facteurs / co-variables

### A) Gène \* environnement

#### --- Température de l'air et SNP331 (ref : bibliographie)

```{r, echo = F}
# par(mfrow = c(1,2))
plot(
  data$mean_T_flight ~ data$air_T,
  ylim = c(
    min(data$mean_T_flight, na.rm = T) - 1,
    max(data$mean_T_flight  + 1, na.rm = T)), ylab = "y", xlab = "Air_T"
    , main = "y ~ T air / SNP331"
  )
points(data$mean_T_flight[data$Pgi_331 == "AA"] ~ data$air_T[data$Pgi_331 == "AA"], pch = 20, cex = 2, col = "red")
points(data$mean_T_flight[data$Pgi_331 == "CA"] ~ data$air_T[data$Pgi_331 == "CA"], pch = 20, cex = 2, col = "blue")
points(data$mean_T_flight[data$Pgi_331 == "CC"] ~ data$air_T[data$Pgi_331 == "CC"], pch = 20, cex = 2, col = "green")
legend("bottomright", legend = c("AA","CA","CC"),
       col = c("red","blue","green"), pch = 20, pt.cex = 2, cex = 0.8)

```

On n'observe pas de pattern clair d'interaction entre la température de l'air et le SNP331 sur la température du vol (tous les groupes [couleurs] de points se chevauchent).

\


### B) Sexe \* variables physiologiques et comportementales

#### --- y \~ Masse\*sexe

```{r, echo = F}
plot(
  data$mean_T_flight ~ data$mass,
  ylim = c(
    min(data$mean_T_flight, na.rm = T) - 1,
    max(data$mean_T_flight  + 1, na.rm = T)
  ), ylab = "y", xlab = "Masse"
  , main = ""
)
points(data$mean_T_flight[data$sex == "F"] ~ data$mass[data$sex == "F"], pch = 20, cex = 2, col = "red")
points(data$mean_T_flight[data$sex == "M"] ~ data$mass[data$sex == "M"], pch = 20, cex = 2, col = "blue")
legend("bottomright", legend = c("Femelles","Males"),
       col = c("red","blue"), pch = 20, pt.cex = 2, cex = 0.8)

```

Les femelles sont nettement plus lourdes que les mâles ! Pas d'intéraction sexe x masse sur la température moyenne du corps pendant le vol.

\


#### --- y \~ sexe\*FMR

```{r, echo = F}
plot(
  data$mean_T_flight ~ data$FMR,
  ylim = c(
    min(data$mean_T_flight, na.rm = T) - 1,
    max(data$mean_T_flight  + 1, na.rm = T)
  ), ylab = "y", xlab = "FMR"
  , main = ""
)
points(data$mean_T_flight[data$sex == "F"] ~ data$FMR[data$sex == "F"], pch = 20, cex = 2, col = "red")
points(data$mean_T_flight[data$sex == "M"] ~ data$FMR[data$sex == "M"], pch = 20, cex = 2, col = "blue")
legend("bottomright", legend=c("Femelles","Males"),
       col = c("red","blue"), pch = 20, pt.cex = 2, cex = 0.8)

```
Pas d'interaction visible sexe*FMR sur la température.

\

#### --- y \~ sexe\*flight_duration

```{r, echo = F}
plot(
  data$mean_T_flight ~ data$flight_duration,
  ylim = c(
    min(data$mean_T_flight, na.rm = T) - 1,
    max(data$mean_T_flight  + 1, na.rm = T)
  ), ylab = "y", xlab = "Durée de vol",
  main = ""
)
points(data$mean_T_flight[data$sex == "F"] ~ data$flight_duration[data$sex == "F"], pch = 20, cex = 2, col = "red")
points(data$mean_T_flight[data$sex == "M"] ~ data$flight_duration[data$sex == "M"], pch = 20, cex = 2, col = "blue")
legend("topleft", legend =c ("Femelles","Males"),
       col=c("red","blue"), pch = 20, pt.cex = 2 ,cex = 0.8)

```

Pas d'interaction visible sexe*durée du vol sur la température.

\

#### --- y \~ sexe\*température au décollage

```{r, echo = F}
plot(
  data$mean_T_flight ~ data$takeoff_T_thorax,
  ylim = c(
    min(data$mean_T_flight, na.rm = T) - 1,
    max(data$mean_T_flight  + 1, na.rm = T)
  ), ylab = "y", xlab = "Température au décollage",
  main = ""
)
points(data$mean_T_flight[data$sex == "F"] ~ data$takeoff_T_thorax[data$sex == "F"], pch = 20, cex = 2, col = "red")
points(data$mean_T_flight[data$sex == "M"] ~ data$takeoff_T_thorax[data$sex == "M"], pch = 20, cex = 2, col = "blue")
legend("topleft",legend=c("Femelles","Males"),col=c("red","blue"),pch=20,pt.cex=2)

```

Pas d'interaction sexe*température au décollage sur la température pendant le vol.

#### --- y \~ sexe\*SNP331

```{r, echo = F}
boxplot(
  data$mean_T_flight ~ interaction(data$sex,data$Pgi_331, lex.order = T),
  main = "",
  ylim = c(
    min(data$takeoff_T_thorax, na.rm = T) - 1,
    max(data$takeoff_T_thorax  + 1, na.rm = T)
  ), ylab = "y", xlab = "SNP 331",
  names = c("AA","CA","CC","AA","CA","CC"),
  col = c(rep("red", 3), rep("blue", 3)),
  cex.names = .6
)
legend("topleft",legend=c("Femelles","Males"),col=c("red","blue"),pch=20,pt.cex=2)

```

#### --- y \~ sexe\*SNP105

```{r, echo = F}
boxplot(
  data$mean_T_flight ~ interaction(data$sex,data$Pgi_105, lex.order = T),
  main = "",
  ylim = c(
    min(data$takeoff_T_thorax, na.rm = T) - 1,
    max(data$takeoff_T_thorax  + 1, na.rm = T)
  ), ylab = "y", xlab = "SNP 105",
  names = c("AA","TA","TT","AA","TA","TT"),
  col = c(rep("red", 3), rep("blue", 3)),
  cex.names = .6
)
legend("topleft",legend=c("Femelles","Males"),col=c("red","blue"),pch=20,pt.cex=2)
```

\

#### --- y \~ sexe\*SNP1083

```{r, echo = F}
boxplot(
  data$mean_T_flight ~ interaction(data$sex,data$Pgi_1083, lex.order = T),
    main = "",
  ylim = c(
    min(data$takeoff_T_thorax, na.rm = T) - 1,
    max(data$takeoff_T_thorax  + 1, na.rm = T)
  ), ylab = "y", xlab = "SNP 1083",
  names = c("AA","AG","GG","AA","AG","GG"),
  col = c(rep("red", 3), rep("blue", 3)),
  cex.names = .6
)
legend("topleft",legend=c("Femelles","Males"),col=c("red","blue"),pch=20,pt.cex=2)
```

Aucune interaction claire entre le sexe et les variables génétiques.

# COLINEARITE ----------------------------------------------

```{r, fig.width=8, fig.height=8, fig.show='asis', echo = F, warning=F}
data_num_short <- data_num[,!colnames(data_num) %in% "mean_T_flight"]
colnames(data_num_short) <- c(
  "Eclosion",
  "FMR_d",
  "mass",
  "FMR",
  "flight_day",
  "age_fli",
  "air_T",
  "dew",
  "humidity",
  "solar",
  "fl_duration",
  "takeoff_fli",
  "takeoff_T",
  "end_fli"
)
M <- cor(na.omit(data_num_short))

corrplot::corrplot.mixed(
  M,
  upper = "square",
  lower.col = "black",
  tl.col = "black",
  cl.cex = 0.8,
  tl.cex = 0.6,
  number.cex = 0.8
)
```

On choisit un seuil de corrélation **R = .7**. On observe une corrélation forte entre les variables :

-   end_flight_time & takeoff_time [R=1]
-   eclosion_day & FMR_day [R=.99]
-   dew_flight & humidity [R=.82]
-   eclosion_day  & flight_day [.91]
-   FMR_day & flight_day [.91]


\

#### --- Suppression des variables corrélées

```{r}
data <- data[!colnames(data) %in% c("eclosion_day", "dew_flight", "stop_flight", "end_flight_time", "flight_day", "age_flight")]

# On renomme le nom des lignes
rownames(data) <- 1:nrow(data)
```

\
\

# MODELISATION ----------------------------------------------
Notre variable y : **mean_T_flight** [température moyenne pendant le vol] est quantitative. Nous cherchons à l'expliquer selon plusieurs variables qualitatives et quantitatives de façon à déterminer (1) quelles variables participent à la prédiction de la température du corps pendant le vol et (2) quantitifier l'importance prédictive relative de ces variables prédictives. Pour cela, nous avons décidé de modéliser cette variable **mean_T_flight** avec un modèle type GLM de distribution Gaussienne (comme vu précédemment, y suit plus ou moins une loi normale et sa relation avec les autres variables prédictives semblent linéaires).  Nous avons réalisé deux analyses A. sans effets aléatoires et B. avec effet aléatoire.



### A. Sans effets aléatoires
On commence par le modèle "complet" en intégrant toutes les variables interprétables.
```{r}
mod <- lm(formula = mean_T_flight ~  FMR_day + age_FMR + FMR + sun_flight + air_T + humidity_flight + solar_radiation_flight + flight_duration + disturbed_flight + takeoff_T_thorax + (takeoff_time + mass + Pgi_105 + Pgi_1083 + Pgi_331)*sex,
      data = data)
```

\

#### --- Multicolinéarité avec test VIF

On choisit un seuil entre \>=5 pour le score VIF.

**Par itération**

```{r, message = F, warning=F}
coli <- vif(mod, type = 'predictor')  # on supprime la variable wind_flight
coli[coli$GVIF == max(coli$GVIF),]["GVIF"]  # identification du plus grand vif
```

\

On supprime la variable 'Pgi_105'

```{r, message = F, warning=F, echo = F}
mod <- lm(formula = mean_T_flight ~  FMR_day + age_FMR + FMR + sun_flight + air_T + humidity_flight + solar_radiation_flight + flight_duration + disturbed_flight + takeoff_T_thorax + (takeoff_time + mass + Pgi_1083 + Pgi_331)*sex,
      data = data)

coli <- vif(mod, type = 'predictor')

coli[coli$GVIF == max(coli$GVIF),]["GVIF"]
```

\

On supprime la variable 'Pgi_1083'

```{r, message = F, warning=F, echo = F}
mod <- lm(formula = mean_T_flight ~  FMR_day + age_FMR + FMR + sun_flight + air_T + humidity_flight + solar_radiation_flight + flight_duration + disturbed_flight + takeoff_T_thorax + (takeoff_time + mass + Pgi_331)*sex,
      data = data)
coli <- vif(mod, type = 'predictor')
coli[coli$GVIF == max(coli$GVIF),]["GVIF"]

```

\

On supprime la variable 'takeoff_time'

```{r, message = F, warning=F, echo = F}
mod <- lm(formula = mean_T_flight ~  FMR_day + age_FMR + FMR + sun_flight + air_T + humidity_flight + solar_radiation_flight + flight_duration + disturbed_flight + takeoff_T_thorax + (mass + Pgi_331)*sex,
      data = data)

coli <- vif(mod, type = 'predictor')

coli[coli$GVIF == max(coli$GVIF),]["GVIF"]

```

\

On supprime la variable 'Pgi_331'

```{r, message = F, warning=F, echo = F}
mod <- lm(formula = mean_T_flight ~  FMR_day + age_FMR + FMR + sun_flight + air_T + humidity_flight + solar_radiation_flight + flight_duration + disturbed_flight + takeoff_T_thorax + mass*sex,
      data = data)

coli <- vif(mod, type = 'predictor')

coli[coli$GVIF == max(coli$GVIF),]["GVIF"]

```



**La colinéarité a été contrôlée !**

\
\

#### --- Selection du meilleur modèle

On sélectionne le meilleur modèle avec une procédure backward / forward baséé sur le critère de l'AIC.

```{r, results = 'hide', message = F}
# On extrait la formule du modèle final
initial_formula <- formula(mod)

# Création modèle initial
initial_model <- lm(initial_formula, data = data)

# Utiliser step() pour sélectionner les termes du modèle
final_model <- step(initial_model, direction = "both", trace = FALSE, k = 3)

# Résultats
summary(final_model)
```

```{r}
Anova(final_model, type = "III")
```

Tous les prédicteurs sont significatifs, c'est notre modèle candidat.   
NOTE : on utilise une ANOVA de type III car la distribution des effectifs des modalités de la variable catégorielle 'disturbed_flight' est inégale.

```{r}
mod_candidat <- final_model
```

Le **modèle candidat final** est donc le modèle ci-dessus. Avant de l'interpréter on évalue la qualité du modèle.

\
\

#### --- Evaluations des résidus
**Normalité,  homogénéité des variance et contributions aberrantes (Cooks)** 
```{r, echo = F}
par(mfrow = c(1, 2))
hist(mod_candidat$residuals, col = "blue", breaks = 20, main = "Histogram of model residuals")
qqnorm(mod_candidat$residuals,pch=16,col='blue',xlab='')
qqline(mod_candidat$residuals,col='red')

# Résidus vs fitted
plot(residuals(mod_candidat)~fitted(mod_candidat),
      col='blue',
      pch=16,
     ylab = "Résidus")
abline(h = 0)

# Cooks : présence de contributions aberrantes
plot(cooks.distance(mod_candidat), type = "h", ylim = c(0, 1), main = "Cooks distribuance", ylab = "Distance de Cooks")
abline(h = 1, col = 2,lwd = 3)
```

Deux points semblent se démarquer dans les résidus. On identifie leur ligne :
```{r}
outliers <- as.numeric(names(which(mod_candidat$residuals < -4)))
outliers
```
Ces outliers correspondent aux lignes 38 et 79.

\

On cherche à quelles variables sont associés les outliers en représantant y ~ chaque variable prédictive avec : 

- rond plein : disturbed == YES 
- rond vide : disturbed == NO

Les outliers sont représentés en rouges.

```{r, echo = F}
# Extraction noms des variables prédictives du modèle
var_mod <- all.vars(formula(mod_candidat))
var_mod <- var_mod[!var_mod %in% "mean_T_flight"]

par(mfrow = c(1,3))
i <- 1
visu <- apply(X = data_num[, colnames(data_num) %in% var_mod], MARGIN = 2, function(x){
  
  plot(
    data$mean_T_flight  ~ x,
    ylab = "T",
    main = "",
    xlab = colnames(data_num[, colnames(data_num) %in% var_mod])[i],
    ylim = c(
      min(data$mean_T_flight, na.rm = T) - 1,
      max(data$mean_T_flight  + 1, na.rm = T)
    )
  )
  points(data$mean_T_flight[data$disturbed_flight == "YES"] ~ x[data$disturbed_flight == "YES"], col = "black", pch = 19)
  
  points(data$mean_T_flight[outliers] ~ x[outliers], col = "red",  pch = 19)
  abline(lm(data$mean_T_flight  ~ x), col = "red")
  
  i <<- i + 1    
}
)
```

Nous n'avons pas réussi à identifier la source de cette variance élevée dans la prédiction de ces deux points. Le graphique de Cooks ne montre cependant pas de contribution trop aberrante, nous considérons que le modèle est interprétable même avec ces deux observations.  
On interprète le modèle :

\
<!-- \ -->

<!-- On teste tout de même le modèle sans ces outliers :  -->
<!-- ```{r} -->
<!-- mod_candidat <- lm(formula(mod_candidat), data = data[-outliers,]) -->
<!-- par(mfrow = c(1, 2)) -->
<!-- hist(mod_candidat$residuals, col = "blue", breaks = 20, main = "Histogram of model residuals") -->
<!-- qqnorm(mod_candidat$residuals,pch=16,col='blue',xlab='') -->
<!-- qqline(mod_candidat$residuals,col='red') -->

<!-- # Résidus vs fitted -->
<!-- plot(residuals(mod_candidat)~fitted(mod_candidat), -->
<!--       col='blue', -->
<!--       pch=16, -->
<!--      ylab = "Résidus") -->
<!-- abline(h = 0) -->

<!-- # Cooks : présence de contributions aberrantes -->
<!-- plot(cooks.distance(mod_candidat), type = "h", ylim = c(0, 1), main = "Cooks distribuance", ylab = "Distance de Cooks") -->
<!-- abline(h = 1, col = 2,lwd = 3) -->
<!-- ``` -->


<!-- ```{r} -->
<!-- summary(mod_candidat) -->
<!-- ``` -->

#### --- Pouvoir explicatif de chaque variable prédictive
Pour rendre compte de la contribution de chaque variable, nous avons calculé le ratio entre la contribution de chaque variable relativement à la variance totale :

```{r}
ano_mod <- Anova(mod_candidat, type = "III")
var_expliquee <- round(ano_mod$`Sum Sq`/ sum(ano_mod$`Sum Sq`), 3)  # Ratio de variance expliquée par variable
```

```{r, echo = F}
var_explique_se <-  names(var_expliquee) <- rownames(ano_mod)

bar <- barplot(var_expliquee, ylab = "% variance expliquée", 
               main = "Variance expliquée par variable",
               ylim = c(0, .6), cex.names = .8, las = 2)
text(
  x = bar,
  y = var_expliquee + .09,
  labels = paste(var_expliquee * 100, "%"),
  pos = 1,
  cex = .8
)
```

\
\

#### --- Modèle final

**Le modèle est donc validé. La température moyenne du corps pendant le vol s'exprime par l'équation suivante :**

```{r, echo = F, include = F}
# Ecriture automatique du modèle
coeff <- round(mod_candidat$coefficients, 2)  # Extraction coefficients
vp_names <- colnames(mod_candidat$model)  # Extraction VP
vp_transfo <- c("eclosion_day", "mass", "FMR_day", "flight_day", "humidity_flight", "flight_duration", "takeoff_time")

                # data$eclosion_day <- log(data$eclosion_day)
# data$mass <- log(data$mass)
# data$FMR_day <- log(data$FMR_day)
# data$flight_day <- log(data$flight_day)
# data$humidity_flight <- log(data$humidity_flight)
# data$flight_duration <- log(data$flight_duration)
# data$takeoff_time <- log(data$takeoff_time)


mod_equation <- paste0("Y = ", coeff[1], " + ")

for(i in 2:length(vp_names)){
  
  if(vp_names[i] %in% vp_transfo){  # Si VP transformé en log, alors mettre en exponentielle
      mod_equation <- paste0(mod_equation,  coeff[i], "*", "exp(", vp_names[i], ") + ")
      next
  
  }
  
  if(i == length(vp_names)){  # Si fin de boucle, ne pas mettre de "+" à la fin de l'équation
      mod_equation <- paste0(mod_equation, coeff[i], "*", vp_names[i])
      break
  }
  
  mod_equation <- paste0(mod_equation, coeff[i], "*", vp_names[i], " + ")
}

mod_equation
```

              
$mean\_T\_flight = 0.32 +0.73 \cdot air\_T - 1.49 \cdot exp(flight\_duration) + 1.53 \cdot disturbed\_flight[== YES] + 0.57 \cdot takeoff\_T\_thorax + \epsilon$

Notre modèle explique 72% de la variation totale de température au vol des papillons (R² = 0.72) et indique que les variables **température au décollage** [contrib = 49%] &  **température de l'air** [contrib = 14%] sont les variables les plus importantes dans la prédiction de la température au vol. Plus la température au décollage et de l'air sont élevées, plus la température moyenne au vol est élevée. Dans une moindre contribution [contrib = 3.6%], la température moyenne au vol augmente lorsque le papillon a été incité à s'envoler par l'expérimentateur (**disturbed_flight**). Nos résultats indiquent également que la **durée du vol** [contrib = 6.7%] impacte négativement la température au vol avec des durées de vol plus longues associées à des températures plus élevées.


\
\

### B. Avec effets aléatoires
On réalise un modèle mixte avec la variable FMR_day (jour de mesure du FMR) comme effet aléatoire. En effet, estimer un coefficient pour ce paramètre n'est pas pertinent pour la question d'étude, on s'intéresse seulement à la variance apportée aux estimations des coefficients des autres variables prédictives.
```{r}
mod <- lmer(formula = mean_T_flight ~  + (1|FMR_day) + age_FMR + FMR + sun_flight + air_T + humidity_flight + solar_radiation_flight + flight_duration + disturbed_flight + takeoff_T_thorax + (takeoff_time + mass + Pgi_105 + Pgi_1083 + Pgi_331)*sex,
      data = data)
```
On obtient un message d'erreur : (singular) fit: see help('isSingular') indiquant une multicolinéarité.

\

#### --- Multicollinéarité avec test VIF

On choisit un seuil entre \>=5 pour le score VIF.

**Par itération**

```{r, warning=F, message = F}
coli <- vif(mod, type = 'predictor')  
coli[,1][coli[,1] == max(coli[,1])]   # identification du plus grand vif
       
       
```

\

On supprime la variable 'Sex'

```{r, echo = F, warning = F, message = F}
mod <- lmer(formula = mean_T_flight ~  + (1|FMR_day) + age_FMR + FMR + sun_flight +
      air_T + humidity_flight + solar_radiation_flight + flight_duration + disturbed_flight +
       takeoff_T_thorax + takeoff_time + mass + Pgi_105 + Pgi_1083 + Pgi_331,
      data = data)

coli <- vif(mod, type = 'predictor')  
coli[,1][coli[,1] == max(coli[,1])]   # identification du plus grand vif
```

\

On supprime la variable 'sun_flight'

```{r, echo = F, warning = F, message = F}
mod <- lmer(formula = mean_T_flight ~  + (1|FMR_day) + age_FMR + FMR +
      air_T + humidity_flight + solar_radiation_flight + flight_duration + disturbed_flight +
       takeoff_T_thorax + takeoff_time + mass + Pgi_105 + Pgi_1083 + Pgi_331,
      data = data)

coli <- vif(mod, type = 'predictor')  
coli[,1][coli[,1] == max(coli[,1])]   # identification du plus grand vif

```

\

Plus de colinéarité dans les effets fixes. On teste la colinéarité de l'effet principal en l'intégrant comme effet fixe :

```{r, echo = F, warning = F, message = F}
mod <- lm(formula = mean_T_flight ~  + FMR_day + age_FMR + FMR +
      air_T + humidity_flight + solar_radiation_flight + flight_duration + disturbed_flight +
       takeoff_T_thorax + takeoff_time + mass + Pgi_105 + Pgi_1083 + Pgi_331,
      data = data)

coli <- vif(mod, type = 'predictor')
coli[coli$GVIF == max(coli$GVIF),]["GVIF"]  
```

L'effet aléatoire est multicolinéaire (d'où l'erreur "matrice singulière"). Il n'est pas intégrable dans le modèle, on revient donc à notre modèle initial à effets fixes.

\
\


# CROSS VALIDATION DU MODELE ----------------------------------------------

On cherche à valider le pouvoir prédictif du modèle candidat avec la méthode de la validation croisée en K-fold.

L'intérêt est de générer deux sous tableaux de données de tailles différentes : 'Entraînement' pour générer le modèle à partir ce ces données, et 'Test' afin de tester la précision du modèle. Ce processus est effectué K fois et à chaque fois, un score de précision est calculé. 
Le nombre K est choisi en fonction de la taille du dataset. Par défaut, on choisit K = 10. 

Le résultat est une valeur de précision du modèle retenu (R²), les coefficients de chaque variable et l'erreur associée (RMSE et MAE).

La cross validation est possible grâce aux fonction 'trainControl' et 'train' du package 'caret'. 

```{r}
set.seed(100)
k <- 10 # Valeur par defaut souvent utilisee

# Définir le contrôle de la validation croisée avec preProcess
ctrl <- trainControl(method = "cv", number = k) 
# Method = cross validation
# number = nombre de plis
# Mettre l'argument "MedianImpute" permet de combler les NAs

# Entraîner le modèle avec train()
model <- train(mean_T_flight ~ air_T + flight_duration + disturbed_flight + takeoff_T_thorax, data = data, 
               method = "glm", trControl = ctrl, na.action = na.omit) 

# Les NAs sont omis pour avoir le meme modele qu'initialement
# Cependant, il est possible d'utiliser l'argument 'MedianImpute' dans la fonction trainControl pour générer des valeurs pour les NAs

print(model)
```
On obtient une précision moyenne de R² = 0.78 (comparée au R²=0.72 obtenue précédemment) pour le modèle candidat d'après la validation croisée pour k = 10.   

\


Les paramètres pour chaque pli : 
```{r}
model$resample
paste0("R2_mean = ", round(model$results$Rsquared, 3) , " +/- ", round(model$results$RsquaredSD, 3))
```
En moyenne, on retombe sur le même pouvoir explicatif R² avec les résultats des modèles basés sur un sous-échantillonnage aléatoire du jeu de données (R² = 0.785 +/- 0.111) comparé au modèle basé sur l'ensemble du jeu de données (R² = .718).


\
\
\
# -----------------------
# IMPUTATION DES NAS ----------------------------------------------

On cherche à estimer les NAs du dataset pour deux raisons :
- Éviter les erreurs de comparaisons entre les valeurs du critère d'AIC lorsque le nombre d'individus des modèles est différent.
- Vérifier l'impact des variables génétiques précédemment retirées sur notre modèle.

Pour rappel, la proportion de NAs était la suivante au sein du dataset :

```{r, echo=F}
# Barplot
barplot(data_na, ylab="Proportion de NA (%)", main = "Proportion de NA",
        col = couleurs, las = 2, names=colnames(data_na), cex.names = .8)
abline(h = 30, col = "red", lwd =1.5)
?barplot
```

### Fonction d'imputation des NAs

On applique la fonction imputeFAMD() du package 'missMDA', correspondant à une imputation des NAs par AFC.

```{r}
set.seed(427)
# On récupère le dataset original
data <- data_full

# Application de la fonction
imputed_data <- imputeFAMD(data)

# Recuperation du df avec les NAs imputes
noNA_data <- imputed_data$completeObs
```

```{r, echo = F}
# Identification des NAs par variables (en %)
data_na <-
  apply(
    X = noNA_data,
    MARGIN = 2,
    FUN = function(x) round(sum(is.na(x)) / nrow(noNA_data) * 100, 2)
  )

# On trie les variables par ordre croissant selon leur pourcentage en NA
sort(data_na)
```

On peut voir que tous les NAs ont été imputés.

```{r, echo =F}
noNA_data$age_FMR <- mapvalues(noNA_data$age_FMR, from = levels(noNA_data$age_FMR), to = levels(data$age_FMR))
noNA_data$sun_flight <- mapvalues(noNA_data$sun_flight, from = levels(noNA_data$sun_flight), to = levels(data$sun_flight))
noNA_data$wind_flight <- mapvalues(noNA_data$wind_flight, from = levels(noNA_data$wind_flight), to = levels(data$wind_flight))
noNA_data$disturbed_flight <- mapvalues(noNA_data$disturbed_flight, from = levels(noNA_data$disturbed_flight), to = levels(data$disturbed_flight))
noNA_data$stop_flight <- mapvalues(noNA_data$stop_flight, from = levels(noNA_data$stop_flight), to = levels(data$stop_flight))
noNA_data$fln_113 <- mapvalues(noNA_data$fln_113, from = levels(noNA_data$fln_113), to = levels(data$fln_113))
noNA_data$G6p1d_239 <- mapvalues(noNA_data$G6p1d_239, from = levels(noNA_data$G6p1d_239), to = levels(data$G6p1d_239))
noNA_data$Hsp70_1_206 <- mapvalues(noNA_data$Hsp70_1_206, from = levels(noNA_data$Hsp70_1_206), to = levels(data$Hsp70_1_206))
noNA_data$Hsp70_1_134 <- mapvalues(noNA_data$Hsp70_1_134, from = levels(noNA_data$Hsp70_1_134), to = levels(data$Hsp70_1_134))
noNA_data$Hsp70_3_71 <- mapvalues(noNA_data$Hsp70_3_71, from = levels(noNA_data$Hsp70_3_71), to = levels(data$Hsp70_3_71))
noNA_data$Hsp70_4_166 <- mapvalues(noNA_data$Hsp70_4_166, from = levels(noNA_data$Hsp70_4_166), to = levels(data$Hsp70_4_166))
noNA_data$Pgi_105 <- mapvalues(noNA_data$Pgi_105, from = levels(noNA_data$Pgi_105), to = levels(data$Pgi_105))
noNA_data$Pgi_1083 <- mapvalues(noNA_data$Pgi_1083, from = levels(noNA_data$Pgi_1083), to = levels(data$Pgi_1083))
noNA_data$Pgi_331 <- mapvalues(noNA_data$Pgi_331, from = levels(noNA_data$Pgi_331), to = levels(data$Pgi_331))
noNA_data$SDHD_149 <- mapvalues(noNA_data$SDHD_149, from = levels(noNA_data$SDHD_149), to = levels(data$SDHD_149))
noNA_data$TnT2_100 <- mapvalues(noNA_data$TnT2_100, from = levels(noNA_data$TnT2_100), to = levels(data$TnT2_100))
data <- noNA_data
```

\
\

# VISUALISATION DES DONNEES SANS NAs

On visualise de nouveaux les distributions des variables explicatives, cette fois-ci avec les NAs imputés.

#### --- Visualisation des distribution des X

**Facteurs**

```{r, echo = F}
data_factor <- data[,sapply(data, is.factor)]  # factor columns identification

par(mfrow = c(2, 3))
i <- 1
visu <- apply(X = data_factor, MARGIN = 2,
      function(x) {
        bar <- barplot(table(x),main = colnames(data_factor)[i], cex.main = 1, ylab = "Effectifs",
                       ylim = c(0,max(table(x)) + 20))
        text(
          x = bar,
          y = table(x) - 1,
          label = table(x),
          pos = 3
        )  
        
        i <<- i + 1
      }
)
```

Comme vu originalement, es variables **sun_flight** et **wind_flight** ont une modalité ("1") avec respectivement, 1 et 2 réplicats. Ces modalités sont inutilisables pour estimer des paramètres. On créé donc une autre modalité : "\<2".

```{r}
# Reformatage
# --- Sun_flight
data$sun_flight <- ifelse(
    test = data$sun_flight == 1 | data$sun_flight == 2,
    yes = "<2",
    no = data$sun_flight
  )

# --- Wind_flight
data$wind_flight <- ifelse(
    test = data$wind_flight == 1 | data$wind_flight == 2,
    yes = "<2",
    no = data$wind_flight
  )


# Conversion en facteur
data$sun_flight  <- as.factor(data$sun_flight)
data$wind_flight <- as.factor(data$wind_flight)

# On modifie aussi data_factor
data_factor$sun_flight <- data$sun_flight
data_factor$wind_flight <- data$wind_flight

```

\

Revisualisation

```{r, echo = F}
par(mfrow = c(1, 2))

# sun_flight
bar <- barplot(table(data$sun_flight), main = "sun_flight", cex.main = .8, ylim = c(0, 60))
text(x = bar, y = table(data$sun_flight) - 1, label = table(data$sun_flight), pos = 3)  # Effectifs par catégorie

# wind_flight
bar <- barplot(table(data$wind_flight), main = "wind_flight", cex.main = .8, ylim = c(0, 60))
text(x = bar, y = table(data$wind_flight) - 1, label = table(data$wind_flight), pos = 3)  # Effectifs par catégorie

```


\

**Covariables**  
On visualise la distribution des variables quantitatives.

```{r, echo = F}
data_num <- data[,sapply(data, is.numeric)]  # factor columns identification

par(mfrow = c(2,4))
i <- 1
visu <- apply(X = data_num, MARGIN = 2, function(x){
  
  hist(x, main = colnames(data_num)[i])
  qqnorm(x, pch = 16)
  qqline(x, col = 'red')
  
  i <<- i + 1    
}
)

```

On transorme les variables suivantes avec le logaritme pour 'normaliser' la distribution :

-   humidity_flight
-   flight_duration

```{r, echo=F}
# Transformation des données
data$humidity_flight <- log(data$humidity_flight)
data$flight_duration <- log(data$flight_duration)
```


\
\

#### --- Visualisation des distribution mean_T_flight \~ X
**Facteurs**
On visualise la distribution de la variable réponse **mean_T_flight** en fonction des variables catégorielles.

```{r, echo = F}
par(mfrow = c(2,3))
i <- 1
visu <- apply(X = data_factor, MARGIN = 2, function(x){
  
  boxplot(
    data$mean_T_flight ~ x,
    ylab = "y",
    xlab = "",
    main = colnames(data_factor)[i], 
    ylim = c(
      min(data$mean_T_flight, na.rm = T) - 1,
      max(data$mean_T_flight  + 1, na.rm = T)
    )
  )
  i <<- i + 1    
}
)
```

En considérant les barres d'erreurs, on n'observe pas de tendances notables entre les variables prédictives catégorielles et la variable réponse. Ce, même avec les nouvelles variables génétiques.

\

**Covariables**

```{r, echo = F}
par(mfrow = c(2,3))
i <- 1
visu <- apply(X = data_num[! colnames(data_num) %in% "mean_T_flight"], MARGIN = 2, function(x){
  
  plot(
    data$mean_T_flight  ~ x,
    ylab = "T",
    xlab = "",
    main = colnames(data_num)[i],
    ylim = c(
      min(data$mean_T_flight, na.rm = T) - 1,
      max(data$mean_T_flight  + 1, na.rm = T)
    )
  )
  abline(lm(data$mean_T_flight  ~ x), col = "red")
  
  i <<- i + 1    
}
)
```

On observe toujours une relation linéaire positive entre **mean_T_flight** et les variables : eclosion_day, FMR_day, mass, air_T, flight_duration et takeoff_T_thorax. A l'inverse, on observe une relation linéaire négative entre **y** et age_flight, dew_flight, humidity_flight. Aucune relation entre **y** et les variables FMR, solar_radiation_flight, takeoff_time et end_flight_time.

\


# Intéractions entre y \~ facteurs / co-variables

### A) Gène \* environnement

#### --- Température de l'air et SNP331 (ref : bibliographie)

```{r, echo = F}
# par(mfrow = c(1,2))
plot(
  data$mean_T_flight ~ data$air_T,
  ylim = c(
    min(data$mean_T_flight, na.rm = T) - 1,
    max(data$mean_T_flight  + 1, na.rm = T)), ylab = "y", xlab = "Air_T"
    , main = "y ~ T air / SNP331"
  )
points(data$mean_T_flight[data$Pgi_331 == "AA"] ~ data$air_T[data$Pgi_331 == "AA"], pch = 20, cex = 2, col = "red")
points(data$mean_T_flight[data$Pgi_331 == "CA"] ~ data$air_T[data$Pgi_331 == "CA"], pch = 20, cex = 2, col = "blue")
points(data$mean_T_flight[data$Pgi_331 == "CC"] ~ data$air_T[data$Pgi_331 == "CC"], pch = 20, cex = 2, col = "green")
legend("bottomright", legend = c("AA","CA","CC"),
       col = c("red","blue","green"), pch = 20, pt.cex = 2, cex = 0.8)

```

On n'observe pas de pattern clair d'interaction entre la température de l'air et le SNP331 sur la température du vol (tous les groupes [couleurs] de points se chevauchent).

\


### B) Sexe \* variables physiologiques et comportementales

#### --- y \~ Masse\*sexe

```{r, echo = F}
plot(
  data$mean_T_flight ~ data$mass,
  ylim = c(
    min(data$mean_T_flight, na.rm = T) - 1,
    max(data$mean_T_flight  + 1, na.rm = T)
  ), ylab = "y", xlab = "Masse"
  , main = ""
)
points(data$mean_T_flight[data$sex == "F"] ~ data$mass[data$sex == "F"], pch = 20, cex = 2, col = "red")
points(data$mean_T_flight[data$sex == "M"] ~ data$mass[data$sex == "M"], pch = 20, cex = 2, col = "blue")
legend("bottomright", legend = c("Femelles","Males"),
       col = c("red","blue"), pch = 20, pt.cex = 2, cex = 0.8)

```

Les femelles sont nettement plus lourdes que les mâles ! Pas d'intéraction sexe x masse sur la température moyenne du corps pendant le vol.

\


#### --- y \~ sexe\*FMR

```{r, echo = F}
plot(
  data$mean_T_flight ~ data$FMR,
  ylim = c(
    min(data$mean_T_flight, na.rm = T) - 1,
    max(data$mean_T_flight  + 1, na.rm = T)
  ), ylab = "y", xlab = "FMR"
  , main = ""
)
points(data$mean_T_flight[data$sex == "F"] ~ data$FMR[data$sex == "F"], pch = 20, cex = 2, col = "red")
points(data$mean_T_flight[data$sex == "M"] ~ data$FMR[data$sex == "M"], pch = 20, cex = 2, col = "blue")
legend("bottomright", legend=c("Femelles","Males"),
       col = c("red","blue"), pch = 20, pt.cex = 2, cex = 0.8)

```
Pas d'interaction visible sexe*FMR sur la température.

\

#### --- y \~ sexe\*flight_duration

```{r, echo = F}
plot(
  data$mean_T_flight ~ data$flight_duration,
  ylim = c(
    min(data$mean_T_flight, na.rm = T) - 1,
    max(data$mean_T_flight  + 1, na.rm = T)
  ), ylab = "y", xlab = "Durée de vol",
  main = ""
)
points(data$mean_T_flight[data$sex == "F"] ~ data$flight_duration[data$sex == "F"], pch = 20, cex = 2, col = "red")
points(data$mean_T_flight[data$sex == "M"] ~ data$flight_duration[data$sex == "M"], pch = 20, cex = 2, col = "blue")
legend("topleft", legend =c ("Femelles","Males"),
       col=c("red","blue"), pch = 20, pt.cex = 2 ,cex = 0.8)

```

Pas d'interaction visible sexe*durée du vol sur la température.

\

#### --- y \~ sexe\*température au décollage

```{r, echo = F}
plot(
  data$mean_T_flight ~ data$takeoff_T_thorax,
  ylim = c(
    min(data$mean_T_flight, na.rm = T) - 1,
    max(data$mean_T_flight  + 1, na.rm = T)
  ), ylab = "y", xlab = "Température au décollage",
  main = ""
)
points(data$mean_T_flight[data$sex == "F"] ~ data$takeoff_T_thorax[data$sex == "F"], pch = 20, cex = 2, col = "red")
points(data$mean_T_flight[data$sex == "M"] ~ data$takeoff_T_thorax[data$sex == "M"], pch = 20, cex = 2, col = "blue")
legend("topleft",legend=c("Femelles","Males"),col=c("red","blue"),pch=20,pt.cex=2)

```

Pas d'interaction sexe*température au décollage sur la température pendant le vol.

#### --- y \~ sexe\*SNP331

```{r, echo = F}
boxplot(
  data$mean_T_flight ~ interaction(data$sex,data$Pgi_331, lex.order = T),
  main = "",
  ylim = c(
    min(data$takeoff_T_thorax, na.rm = T) - 1,
    max(data$takeoff_T_thorax  + 1, na.rm = T)
  ), ylab = "y", xlab = "SNP 331",
  names = c("AA","CA","CC","AA","CA","CC"),
  col = c(rep("red", 3), rep("blue", 3)),
  cex.names = .6
)
legend("topleft",legend=c("Femelles","Males"),col=c("red","blue"),pch=20,pt.cex=2)

```

#### --- y \~ sexe\*SNP105

```{r, echo = F}
boxplot(
  data$mean_T_flight ~ interaction(data$sex,data$Pgi_105, lex.order = T),
  main = "",
  ylim = c(
    min(data$takeoff_T_thorax, na.rm = T) - 1,
    max(data$takeoff_T_thorax  + 1, na.rm = T)
  ), ylab = "y", xlab = "SNP 105",
  names = c("AA","TA","TT","AA","TA","TT"),
  col = c(rep("red", 3), rep("blue", 3)),
  cex.names = .6
)
legend("topleft",legend=c("Femelles","Males"),col=c("red","blue"),pch=20,pt.cex=2)
```

\

#### --- y \~ sexe\*SNP1083

```{r, echo = F}
boxplot(
  data$mean_T_flight ~ interaction(data$sex,data$Pgi_1083, lex.order = T),
    main = "",
  ylim = c(
    min(data$takeoff_T_thorax, na.rm = T) - 1,
    max(data$takeoff_T_thorax  + 1, na.rm = T)
  ), ylab = "y", xlab = "SNP 1083",
  names = c("AA","AG","GG","AA","AG","GG"),
  col = c(rep("red", 3), rep("blue", 3)),
  cex.names = .6
)
legend("topleft",legend=c("Femelles","Males"),col=c("red","blue"),pch=20,pt.cex=2)
```

Comme précédemment, on a aucune interaction claire entre le sexe et les variables génétiques.

\

## C) Gènes Hsp \* Gènes Pgi

Parmis les nouvelles variables ajoutées, certaines sont des gènes Hsp. Il est possible de trouver dans la littérature des interractions entre l'activation de ces gènes et celle des Hsp. On test dans le lien entre ces variables explicatives catégorielles.

\

#### --- y \~ Pgi_105\*Hsp

```{r, echo=F}
par(mfrow=c(2,2))

#HSP70_1_266
boxplot(
  data$mean_T_flight ~ data$Pgi_105*data$Hsp70_1_206,
    main = "",
  ylim = c(
    min(data$takeoff_T_thorax) - 1,
    max(data$takeoff_T_thorax  + 1)
  ), ylab = "y", 
  xlab = "Pgi_105 * Hsp70_1_206",
  cex.names = .6
)

# HSP70_1_134
boxplot(
  data$mean_T_flight ~ data$Pgi_105*data$Hsp70_1_134,
    main = "",
  ylim = c(
    min(data$takeoff_T_thorax) - 1,
    max(data$takeoff_T_thorax  + 1)
  ), ylab = "y", 
  xlab = "Pgi_105 * Hsp70_1_134",
  cex.names = .6
)

#HSP70_3_71
boxplot(
  data$mean_T_flight ~ data$Pgi_105*data$Hsp70_3_71,
    main = "",
  ylim = c(
    min(data$takeoff_T_thorax) - 1,
    max(data$takeoff_T_thorax  + 1)
  ), ylab = "y", 
  xlab = "Pgi_105 * Hsp70_3_71",
  cex.names = .6
)

#HSP70_4_166
boxplot(
  data$mean_T_flight ~ data$Pgi_105*data$Hsp70_4_166,
    main = "",
  ylim = c(
    min(data$takeoff_T_thorax) - 1,
    max(data$takeoff_T_thorax  + 1)
  ), ylab = "y", 
  xlab = "Pgi_105 * Hsp70_4_166",
  cex.names = .6
)
```
#### --- y \~ Pgi_1083\*Hsp

```{r, echo=F}
par(mfrow=c(2,2))

#HSP70_1_266
boxplot(
  data$mean_T_flight ~ data$Pgi_1083*data$Hsp70_1_206,
    main = "",
  ylim = c(
    min(data$takeoff_T_thorax) - 1,
    max(data$takeoff_T_thorax  + 1)
  ), ylab = "", 
  xlab = "Pgi_1083 * Hsp70_1_206",
  cex.names = .6
)

# HSP70_1_134
boxplot(
  data$mean_T_flight ~ data$Pgi_1083*data$Hsp70_1_134,
    main = "",
  ylim = c(
    min(data$takeoff_T_thorax) - 1,
    max(data$takeoff_T_thorax  + 1)
  ), ylab = "y", 
  xlab = "Pgi_1083 * Hsp70_1_134",
  cex.names = .6
)

#HSP70_3_71
boxplot(
  data$mean_T_flight ~ data$Pgi_1083*data$Hsp70_3_71,
    main = "",
  ylim = c(
    min(data$takeoff_T_thorax) - 1,
    max(data$takeoff_T_thorax  + 1)
  ), ylab = "y", 
  xlab = "Pgi_1083 * Hsp70_3_71",
  cex.names = .6
)

#HSP70_4_166
boxplot(
  data$mean_T_flight ~ data$Pgi_1083*data$Hsp70_4_166,
    main = "",
  ylim = c(
    min(data$takeoff_T_thorax) - 1,
    max(data$takeoff_T_thorax  + 1)
  ), ylab = "y", 
  xlab = "Pgi_1083 * Hsp70_4_166",
  cex.names = .6
)
```

#### --- y \~ Pgi_331\*Hsp

```{r, echo=F}
par(mfrow=c(2,2))

#HSP70_1_266
boxplot(
  data$mean_T_flight ~ data$Pgi_331*data$Hsp70_1_206,
    main = "",
  ylim = c(
    min(data$takeoff_T_thorax) - 1,
    max(data$takeoff_T_thorax  + 1)
  ), ylab = "y", 
  xlab = "Pgi_331 * Hsp70_1_206",
  cex.names = .6
)

# HSP70_1_134
boxplot(
  data$mean_T_flight ~ data$Pgi_331*data$Hsp70_1_134,
    main = "",
  ylim = c(
    min(data$takeoff_T_thorax) - 1,
    max(data$takeoff_T_thorax  + 1)
  ), ylab = "y", 
  xlab = "Pgi_331 * Hsp70_1_134",
  cex.names = .6
)

#HSP70_3_71
boxplot(
  data$mean_T_flight ~ data$Pgi_331*data$Hsp70_3_71,
    main = "",
  ylim = c(
    min(data$takeoff_T_thorax) - 1,
    max(data$takeoff_T_thorax  + 1)
  ), ylab = "y", 
  xlab = "Pgi_331 * Hsp70_3_71",
  cex.names = .6
)

#HSP70_4_166
boxplot(
  data$mean_T_flight ~ data$Pgi_331*data$Hsp70_4_166,
    main = "",
  ylim = c(
    min(data$takeoff_T_thorax) - 1,
    max(data$takeoff_T_thorax  + 1)
  ), ylab = "y", 
  xlab = "Pgi_331 * Hsp70_4_166",
  cex.names = .6
)
```

On observe aucune interraction entre les variables explicatives des gènes Hsp et des gènes Pgi.

# COLINEARITE ----------------------------------------------

```{r, fig.width=8, fig.height=8, fig.show='asis', echo = F, warning=F}
data_num_short <- data_num[,!colnames(data_num) %in% "mean_T_flight"]
colnames(data_num_short) <- c(
  "Eclosion",
  "FMR_d",
  "mass",
  "FMR",
  "flight_day",
  "age_fli",
  "air_T",
  "dew",
  "humidity",
  "solar",
  "fl_duration",
  "takeoff_fli",
  "takeoff_T",
  "end_fli"
)
M <- cor(na.omit(data_num_short))

corrplot::corrplot.mixed(
  M,
  upper = "square",
  lower.col = "black",
  tl.col = "black",
  cl.cex = 0.8,
  tl.cex = 0.6,
  number.cex = 0.8
)
```

On choisit un seuil de corrélation **R = .7**. On observe une corrélation forte entre les variables :

-   end_flight_time & takeoff_time [R=.94]
-   eclosion_day & FMR_day [R=.99]
-   dew_point & humidity [R=.80]
-   eclosion_day & flight_day [0.91]
-   FMR_day & flight_day [0.91]

\

#### --- Suppression des variables corrélées

```{r}
data <- data[!colnames(data) %in% c("eclosion_day", "dew_flight", "stop_flight", "end_flight_time", "flight_day", "age_flight")]

# On renomme le nom des lignes
rownames(data) <- 1:nrow(data)
```

\
\

# MODELISATION ----------------------------------------------

### A. Sans effets aléatoires

Comme précédemment, on commence par le modèle "complet" en intégrant toutes les variables interprétables.

```{r}
mod <- lm(formula = mean_T_flight ~  FMR_day + age_FMR + FMR + sun_flight + air_T + humidity_flight + solar_radiation_flight + flight_duration + disturbed_flight + takeoff_T_thorax + (takeoff_time + mass + Pgi_105 + Pgi_1083 + Pgi_331)*sex + fln_113 + G6p1d_239 + Hsp70_4_166 + Hsp70_3_71 + Hsp70_1_134 + Hsp70_1_206 + SDHD_149 + TnT2_100, 
          data = data)
```


\

#### --- Multicolinéarité avec test VIF

On choisit un seuil entre \>=5 pour le score VIF.

**Par itération**

```{r, message = F, warning=F}
coli <- vif(mod, type = 'predictor')  # on supprime la variable wind_flight
coli[coli$GVIF == max(coli$GVIF),]["GVIF"]  # identification du plus grand vif
```

\

On supprime la variable 'sex'

```{r, message = F, warning=F, echo = F}
mod <- lm(formula = mean_T_flight ~  FMR_day + age_FMR + FMR + sun_flight + air_T + humidity_flight + solar_radiation_flight + flight_duration + disturbed_flight + takeoff_T_thorax + takeoff_time + mass + Pgi_105 + Pgi_1083 + Pgi_331 + fln_113 + G6p1d_239 + Hsp70_4_166 + Hsp70_3_71 + Hsp70_1_134 + Hsp70_1_206 + SDHD_149 + TnT2_100, 
          data = data)

coli <- vif(mod, type = 'predictor')

coli[coli$GVIF == max(coli$GVIF),]["GVIF"]
```

\

On supprime la variable 'sun_flight'

```{r, message = F, warning=F, echo = F}
mod <- lm(formula = mean_T_flight ~  FMR_day + age_FMR + FMR + air_T + humidity_flight + solar_radiation_flight + flight_duration + disturbed_flight + takeoff_T_thorax + takeoff_time + mass + Pgi_105 + Pgi_1083 + Pgi_331 + fln_113 + G6p1d_239 + Hsp70_4_166 + Hsp70_3_71 + Hsp70_1_134 + Hsp70_1_206 + SDHD_149 + TnT2_100, 
          data = data)

coli <- vif(mod, type = 'predictor')
coli[coli$GVIF == max(coli$GVIF),]["GVIF"]

```

\

On supprime la variable 'humidity_flight'

```{r, message = F, warning=F, echo = F}
mod <- lm(formula = mean_T_flight ~  FMR_day + age_FMR + FMR + air_T + solar_radiation_flight + flight_duration + disturbed_flight + takeoff_T_thorax + takeoff_time + mass + Pgi_105 + Pgi_1083 + Pgi_331 + fln_113 + G6p1d_239 + Hsp70_4_166 + Hsp70_3_71 + Hsp70_1_134 + Hsp70_1_206 + SDHD_149 + TnT2_100, 
          data = data)

coli <- vif(mod, type = 'predictor')

coli[coli$GVIF == max(coli$GVIF),]["GVIF"]

```
**La colinéarité a été contrôlée !**

\
\

#### --- Selection du meilleur modèle

On sélectionne le meilleur modèle avec une procédure backward / forward basée sur le critère de l'AIC.

```{r, results = 'hide', message = F}
# On extrait la formule du modèle final
initial_formula <- formula(mod)

# Création modèle initial
initial_model <- lm(initial_formula, data = data)

# Utiliser step() pour sélectionner les termes du modèle
final_model <- step(initial_model, direction = "both", trace = FALSE, k = 3)

# Résultats
summary(final_model)
```

```{r}
Anova(final_model, type = "III")
```

Tous les prédicteurs sont significatifs, c'est notre modèle candidat.   
NOTE : on utilise une ANOVA de type III car la distribution des effectifs des modalités de la variable catégorielle 'disturbed_flight' est inégale.

```{r}
mod_candidat <- final_model
```

Le **modèle candidat final** est donc le modèle ci-dessus. Avant de l'interpréter on évalue la qualité du modèle.

\
\

#### --- Evaluations des résidus
**Normalité,  homogénéité des variance et contributions aberrantes (Cooks)** 
```{r, echo = F}
par(mfrow = c(1, 2))
hist(mod_candidat$residuals, col = "blue", breaks = 20, main = "Histogram of model residuals")
qqnorm(mod_candidat$residuals,pch=16,col='blue',xlab='')
qqline(mod_candidat$residuals,col='red')

# Résidus vs fitted
plot(residuals(mod_candidat)~fitted(mod_candidat),
      col='blue',
      pch=16,
     ylab = "Résidus")
abline(h = 0)

# Cooks : présence de contributions aberrantes
plot(cooks.distance(mod_candidat), type = "h", ylim = c(0, 1), main = "Cooks distribuance", ylab = "Distance de Cooks")
abline(h = 1, col = 2,lwd = 3)
```


#### --- Pouvoir explicatif de chaque variable prédictive
Pour rendre compte de la contribution de chaque variable, nous avons de nouveau calculé le ratio entre la contribution de chaque variable relativement à la variance totale :

```{r}
ano_mod <- Anova(mod_candidat, type = "III")
var_expliquee <- round(ano_mod$`Sum Sq`/ sum(ano_mod$`Sum Sq`), 3)  # Ratio de variance expliquée par variable
```
```{r, echo = F}
var_explique_se <-  names(var_expliquee) <- rownames(ano_mod)

bar <- barplot(var_expliquee, ylab = "% variance expliquée", 
               main = "Variance expliquée par variable",
               ylim = c(0, .6), cex.names = .8, las = 2)
text(
  x = bar,
  y = var_expliquee + .09,
  labels = paste(var_expliquee * 100, "%"),
  pos = 1,
  cex = .8
)
```

\
\

#### --- Modèle final

**Le modèle est donc validé. La température moyenne du corps pendant le vol s'exprime par l'équation suivante :**

```{r, echo = F, include = F}
# Ecriture automatique du modèle
coeff <- round(mod_candidat$coefficients, 2)  # Extraction coefficients
vp_names <- colnames(mod_candidat$model)  # Extraction VP
vp_transfo <- c("eclosion_day", "mass", "FMR_day", "flight_day", "humidity_flight", "flight_duration", "takeoff_time")

                # data$eclosion_day <- log(data$eclosion_day)
# data$mass <- log(data$mass)
# data$FMR_day <- log(data$FMR_day)
# data$flight_day <- log(data$flight_day)
# data$humidity_flight <- log(data$humidity_flight)
# data$flight_duration <- log(data$flight_duration)
# data$takeoff_time <- log(data$takeoff_time)


mod_equation <- paste0("Y = ", coeff[1], " + ")

for(i in 2:length(vp_names)){
  
  if(vp_names[i] %in% vp_transfo){  # Si VP transformé en log, alors mettre en exponentielle
      mod_equation <- paste0(mod_equation,  coeff[i], "*", "exp(", vp_names[i], ") + ")
      next
  
  }
  
  if(i == length(vp_names)){  # Si fin de boucle, ne pas mettre de "+" à la fin de l'équation
      mod_equation <- paste0(mod_equation, coeff[i], "*", vp_names[i])
      break
  }
  
  mod_equation <- paste0(mod_equation, coeff[i], "*", vp_names[i], " + ")
}

mod_equation
```


$mean\_T\_flight = 2.79 + 0.62 \cdot air\_T - 1.33 \cdot exp(flight\_duration) + 1.34 \cdot disturbed\_flight[== YES] + 0.54 \cdot takeoff\_T\_thorax + \epsilon$

Notre modèle indique que les variables **température au décollage** [contrib = 49%] &  **température de l'air** [contrib = 14%] sont les variables les plus importantes dans la prédiction de la température au vol. Plus la température au décollage et de l'air sont élevées, plus la température moyenne au vol est élevée. Dans une moindre contribution [contrib = 3.6%], la température moyenne au vol augmente lorsque le papillon a été incité à s'envoler par l'expérimentateur (**disturbed_flight**). Nos résultats indiquent également que la **durée du vol** [contrib = 6.7%] impacte négativement la température au vol avec des durées de vol plus longues associées à des températures plus élevées.


\
\

# CROSS VALIDATION DU MODELE (NA) ----------------------------------------------

On cherche à valider le pouvoir prédictif du modèle candidat avec la méthode de la validation croisée en K-fold.

L'intérêt est de générer deux sous tableaux de données de tailles différentes : 'Entraînement' pour générer le modèle à partir ce ces données, et 'Test' afin de tester la précision du modèle. Ce processus est effectué K fois et à chaque fois, un score de précision est calculé. 
Le nombre K est choisi en fonction de la taille du dataset. Par défaut, on choisit K = 10. 

Le résultat est une valeur de précision du modèle retenu (R²), les coefficients de chaque variable et l'erreur associée (RMSE et MAE).

La cross validation est possible grâce aux fonction 'trainControl' et 'train' du package 'caret'. 

```{r}
set.seed(100)
k <- 10 # Valeur par defaut souvent utilisee

# Définir le contrôle de la validation croisée avec preProcess
ctrl <- trainControl(method = "cv", number = k) 
# Method = cross validation
# number = nombre de plis
# Mettre l'argument "MedianImpute" permet de combler les NAs

# Entraîner le modèle avec train()
model <- train(mean_T_flight ~ air_T + flight_duration + disturbed_flight + takeoff_T_thorax, data = data, 
               method = "glm", trControl = ctrl, na.action = na.omit) 

# Les NAs sont omis pour avoir le meme modele qu'initialement
# Cependant, il est possible d'utiliser l'argument 'MedianImpute' dans la fonction trainControl pour générer des valeurs pour les NAs

print(model)
```
On obtient une précision moyenne de R² = 0.78 (comparée au R²=0.72 obtenue précédemment) pour le modèle candidat d'après la validation croisée pour k = 10.   

\


Les paramètres pour chaque pli : 
```{r}
model$resample
paste0("R2_mean = ", round(model$results$Rsquared, 3) , " +/- ", round(model$results$RsquaredSD, 3))
```
En moyenne, on retombe sur le même pouvoir explicatif R² avec les résultats des modèles basés sur un sous-échantillonnage aléatoire du jeu de données (R² = 0.756 +/- 0.153) comparé au modèle basé sur l'ensemble du jeu de données (R² = .719).


\
\

# Conclusion
Les différentes approches de modélisation ont donné des résultats similaires que ce soit (1) avec la méthode de validation croisée et/ou (2) l'imputation des données manquantes. On retrouve globablement le même modèle. L'imputation des données manquantes a permis de confirmer l'absence de contribution des variables génétiques, qui n'ont pas été retrouvé dans le modèle final pour expliquer la température au vol du papillon.  La méthode de validation croisée a permis de confirmer que le pouvoir prédictif du modèle initital était stable (cf R2).